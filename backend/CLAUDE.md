# Backend ‚Äî AI Image Generator Bot

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
Backend API –¥–ª—è Telegram Web App. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ kie.ai, —á–∞—Ç —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ OpenRouter, –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ÆKassa.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- **FastAPI 0.109+**: Async –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **SQLAlchemy 2.0**: Async ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
- **Alembic**: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **Celery + Redis**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
- **PostgreSQL 15**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å JSONB –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
- **Pydantic**: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/              # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py       # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Telegram initData, JWT)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fitting.py    # –ü—Ä–∏–º–µ—Ä–∫–∞ –æ–¥–µ–∂–¥—ã/–∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ editing.py    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payments.py   # –ü–ª–∞—Ç–µ–∂–∏ –∏ webhook –ÆKassa
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py    # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –±–∞–ª–∞–Ω—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referrals.py  # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py      # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Pydantic Settings)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py   # JWT, HMAC, –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deps.py       # Dependencies –¥–ª—è FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py       # Base class –¥–ª—è –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py    # Async —Å–µ—Å—Å–∏–∏ SQLAlchemy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ init_db.py    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py       # –ú–æ–¥–µ–ª—å User
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generation.py # –ú–æ–¥–µ–ª—å Generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.py       # –ú–æ–¥–µ–ª—å ChatHistory
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.py    # –ú–æ–¥–µ–ª—å Payment
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referral.py   # –ú–æ–¥–µ–ª—å Referral
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py       # Pydantic —Å—Ö–µ–º—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fitting.py    # –°—Ö–µ–º—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ editing.py    # –°—Ö–µ–º—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.py    # –°—Ö–µ–º—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.py       # –°—Ö–µ–º—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kie_ai.py     # –ö–ª–∏–µ–Ω—Ç –¥–ª—è kie.ai API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openrouter.py # –ö–ª–∏–µ–Ω—Ç –¥–ª—è OpenRouter API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ yukassa.py    # –ö–ª–∏–µ–Ω—Ç –¥–ª—è –ÆKassa API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.py   # Telegram Bot API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image.py      # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ credits.py    # –õ–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è/–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ celery_app.py # Celery –∑–∞–¥–∞—á–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ main.py           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI
‚îú‚îÄ‚îÄ alembic/              # –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic
‚îú‚îÄ‚îÄ tests/                # –¢–µ—Å—Ç—ã (pytest)
‚îú‚îÄ‚îÄ .env.example          # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt      # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ CLAUDE.md             # –≠—Ç–æ—Ç —Ñ–∞–π–ª

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–¥—É–ª–∏

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (api/auth.py)
- –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData —á–µ—Ä–µ–∑ HMAC SHA-256
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- –í—ã–¥–∞—á–∞ JWT-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Å–µ—Å—Å–∏–π
- Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞

### 2. –ü—Ä–∏–º–µ—Ä–∫–∞ (api/fitting.py)
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /api/v1/fitting/upload` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–¥–µ–∂–¥—ã
  - `POST /api/v1/fitting/generate` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ kie.ai
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ (MIME, magic bytes, —Ä–∞–∑–º–µ—Ä ‚â§5MB)
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —É—á—ë—Ç–æ–º –∑–æ–Ω—ã –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
- Celery-–∑–∞–¥–∞—á–∞ –¥–ª—è async –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- WebSocket –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- –°–ø–∏—Å–∞–Ω–∏–µ 2 –∫—Ä–µ–¥–∏—Ç–æ–≤

### 3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (api/editing.py)
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /api/v1/editing/upload` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
  - `POST /api/v1/editing/chat` ‚Äî –∑–∞–ø—Ä–æ—Å –∫ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É (WebSocket)
  - `POST /api/v1/editing/generate` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ kie.ai
  - `POST /api/v1/editing/reset` ‚Äî —Å–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π) ‚Üí OpenRouter
- AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ JSONB (30 –¥–Ω–µ–π)
- –°–ø–∏—Å–∞–Ω–∏–µ: 1 –∫—Ä–µ–¥–∏—Ç –∑–∞ –∑–∞–ø—Ä–æ—Å + 1 –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- –£—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ OpenRouter (input/output)

### 4. –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è (api/payments.py)
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /api/v1/payments/create` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa
  - `POST /api/v1/payments/webhook` ‚Äî webhook –æ—Ç –ÆKassa
  - `GET /api/v1/balance` ‚Äî –±–∞–ª–∞–Ω—Å –∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ì–∏–±—Ä–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å: Freemium (10/–º–µ—Å—è—Ü), –ø–æ–¥–ø–∏—Å–∫–∏, –∫—Ä–µ–¥–∏—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ (idempotency_key)
- –†–∞—Å—á—ë—Ç –ù–ü–î 4% + –∫–æ–º–∏—Å—Å–∏—è –ÆKassa 2.8%
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è "–ú–æ–π –Ω–∞–ª–æ–≥"

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (services/)
- **kie_ai.py**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Nano Banana (~2.5‚ÇΩ/–≥–µ–Ω–µ—Ä–∞—Ü–∏—é)
  - Retry: 3 –ø–æ–ø—ã—Ç–∫–∏, exponential backoff
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á–µ—Ä–µ–∑ WebSocket
- **openrouter.py**: Claude Haiku –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (~0.07‚ÇΩ/–∑–∞–ø—Ä–æ—Å)
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤
  - –£—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤
- **yukassa.py**: –ü–ª–∞—Ç–µ–∂–∏, webhook
- **telegram.py**: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —á–∞—Ç

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (models/)

### Users
- `id` (PK), `telegram_id` (unique)
- `balance_credits` (int) ‚Äî –∫—Ä–µ–¥–∏—Ç—ã
- `subscription_type` (enum: null, basic, pro, premium)
- `subscription_end` (datetime)
- `freemium_actions_used` (int) ‚Äî —Å—á—ë—Ç—á–∏–∫ –¥–ª—è Freemium
- `created_at`, `updated_at`

### Generations
- `id` (PK), `user_id` (FK)
- `type` (enum: 'fitting', 'editing')
- `user_photo_url`, `item_photo_url` (–¥–ª—è –ø—Ä–∏–º–µ—Ä–∫–∏)
- `prompt` (text)
- `image_url` (text)
- `credits_spent` (int)
- `tokens_used` (decimal) ‚Äî –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `created_at`

### ChatHistory
- `id` (PK), `user_id` (FK)
- `session_id` (UUID, unique)
- `messages` (JSONB) ‚Äî [{role, content, image_url, timestamp}]
- `created_at`, `updated_at`
- –•—Ä–∞–Ω–∏—Ç—Å—è 30 –¥–Ω–µ–π, –∑–∞—Ç–µ–º –∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ

### Payments
- `id` (PK), `user_id` (FK)
- `yookassa_id` (unique)
- `amount` (decimal)
- `status` (enum: pending, succeeded, cancelled)
- `tax_amount` (decimal) ‚Äî –ù–ü–î 4%
- `commission_amount` (decimal) ‚Äî –ÆKassa 2.8%
- `tokens_used` (decimal)
- `idempotency_key` (unique)
- `created_at`, `updated_at`

### Referrals
- `id` (PK), `referrer_id` (FK), `referred_id` (FK)
- `credits_awarded` (int) ‚Äî +10 –∫—Ä–µ–¥–∏—Ç–æ–≤
- `created_at`

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –ö–û–î–û–ú

### ‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

1. **–ù–ï –£–†–ï–ó–ê–¢–¨ –ö–û–î**:
   - –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–º–µ–Ω—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –Ω–∞ –∑–∞–≥–ª—É—à–∫–∏ —Ç–∏–ø–∞ `# ... existing code ...`
   - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π—Ç–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ `# ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...`
   - –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –º–æ–¥—É–ª—è/—Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –ü—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–≥–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

2. **–ù–ï –°–û–ó–î–ê–í–ê–¢–¨ –î–£–ë–õ–ò**:
   - –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –ª—é–±–æ–≥–æ –∫–æ–¥–∞, —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –º–æ–¥—É–ª—è ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Grep/Glob –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–∂–µ –µ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–π
   - –ù–µ –ø–ª–æ–¥–∏—Ç–µ –∫–æ–ø–∏–∏ –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –ª–æ–≥–∏–∫–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

3. **–ù–ï –£–î–ê–õ–Ø–¢–¨ –§–£–ù–ö–¶–ò–û–ù–ê–õ**:
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω —É—Ä–µ–∑–∞—Ç—å—Å—è –±–µ–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É ‚Äî —Å–ø—Ä–æ—Å–∏—Ç–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–µ–∂–¥–µ —á–µ–º —É–¥–∞–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
   - –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±–∞–≥–æ–≤:

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
async def some_function():
    # ... existing code ...
    fixed_line = await new_logic()
    # ... rest of code ...

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
async def some_function():
    # –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
    existing_logic_line_1 = await something()
    existing_logic_line_2 = process(existing_logic_line_1)
    fixed_line = await new_logic()  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    existing_logic_line_3 = more_processing(fixed_line)
    return result
```

### üìã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ß–ï–ö-–õ–ò–°–¢ –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–¥–∞:

1. [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è/–º–æ–¥—É–ª—å? (Grep/Glob)
2. [ ] –£–≤–µ—Ä–µ–Ω, —á—Ç–æ –Ω–µ –¥—É–±–ª–∏—Ä—É—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥?
3. [ ] –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–æ–ª–Ω—ã–π –∫–æ–¥ –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫?
4. [ ] –°–æ—Ö—Ä–∞–Ω—è—é –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª?
5. [ ] –°–ø—Ä–æ—Å–∏–ª —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —Å–æ–±–∏—Ä–∞—é—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª?

## –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Async –≤–µ–∑–¥–µ**: –í—Å–µ IO-–æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ async/await
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤**: MIME + magic bytes, –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
3. **Celery –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**: –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FastAPI BackgroundTasks
4. **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞**: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ OpenRouter
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –í—Å–µ API-–∫–ª—é—á–∏ —á–µ—Ä–µ–∑ .env
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram initData —á–µ—Ä–µ–∑ HMAC
   - SQL-injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ ORM
   - XSS sanitization
6. **GDPR**:
   - –§–æ—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∫–∏ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 24—á
   - –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- Retry –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (tenacity: 3 –ø–æ–ø—ã—Ç–∫–∏, exponential backoff)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ Sentry
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- WebSocket –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## –ó–∞–ø—É—Å–∫

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m venv venv
source venv/bin/activate  # Linux/Mac
# –∏–ª–∏
venv\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env
cp .env.example .env
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# –ó–∞–ø—É—Å–∫ Celery worker (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
celery -A app.tasks.celery_app worker --loglevel=info

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest tests/ -v --cov=app
```

## TODO
- [ ] –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ SQLAlchemy
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å kie.ai API
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å OpenRouter API
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ÆKassa
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Celery –¥–ª—è async –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
